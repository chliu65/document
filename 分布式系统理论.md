# 分布式系统设计

### 1.分布式系统设计思路

##### **中心化：**

分布式集群中的机器节点按照角色分为“master”和“slave”。master负责分发任务（涉及到负载均衡策略）、监控从节点、维护集群的健康（剔除挂掉的从节点）。

**应用：**kubernetes

**存在问题：**master挂了，整个系统崩溃。

**解决方案：**采用主备两个mater的设计方案，自动切换或手动切换。以及自动选举切换领导。

##### **去中心化：**

**存在问题：**脑裂问题，一个集群由于网络故障，被分割为多个无法通信的单独集群，在在同时工作时，会产生数据冲突。

**解决方案：**发生脑裂问题时，规模小的集群主动关闭服务。

应用：zookeeper

### 2.CAP理论

一致性、可用性、分区容错性

一致性：同一数据在多个节点中是一样的。

可用性：每一个操作总是能够在一定的时间内返回结果

分区容错性：部分节点挂掉，其他节点仍可以提供服务（满足一致性和可用性）。

分布式系统需要保证分区容错性，所以需要权衡优先保证一致性还是可用性。

zookeeper优先保障一致性。eureka优先保障可用性。

### 3.BASE理论

举例;https://blog.csdn.net/qq_42332821/article/details/104283428

**Basically Available（基本可用）：**基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性，例如响应时间可能会增加，部分功能损失（服务降级）。

**Soft-state（软状态）：** 软状态指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时.

**Eventually Consistent（最终一致性）：**系统中所有的数据副本，在**经过一段时间的同步后**，最终能够达到一个一致的状态。

### 4.分布式事务

指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

分布式事务主要为了保证不同数据库的数据一致性，出现场景：支付（买家账户付款，卖家账户入账）、下单（扣库存与更新订单状态）

**分布式事务解决方案：**

1.基于XA协议两阶段提交

XA分为两个部分：事务管理器与本地资源管理器。本地资源管理器由数据库实现。事务管理器作为全局调度者，负责各个本地资源的提交与回滚。

**步骤：**

事务管理器通知参与该事务的各个资源管理器，准备事务。

资源管理器接受到消息后开始准备节点，写好事务日志并执行事务，但不提交，然后将是否就绪的消息返还给事务管理器。

事务管理器接收各个消息后，如果有任一资源管理器回复失败，则发送回滚命令，否则发送提交。

各资源管理器接收命令执行，返还提价结果。

**缺点：**无法满足高并发场景，如果有一个或多个资源管理器不回复消息，会一直被阻塞。

2.MQ事务消息

RocketMQ支持事务消息。RabbitMQ和Kafka不支持。

业务方法要向消息队列提交两次请求，一次发送，一次确认。如果确认消息发送失败了，MQ会定期扫描消息集群中的事务消息，发现消息没有确认，则会向消息发送者确认，是回滚还是继续发送确认消息。

**缺点：**目前只有RocketMQ支持，没有.net客户端，部分代码未开源。

3.TCC（补偿事务）

将整个业务逻辑分为三块：Try、Confirm和Cancel三个操作。在cancel阶段执行补偿方法。

4.结合MQ消息中间件实现的可靠消息最终一致性

可靠消息最终一致性，需要业务系统结合MQ消息中间件实现，在实现过程中需要保证消息的成功发送及成功消费。即需要通过业务系统控制MQ的消息状态。

### 5.一致性协议/算法

